{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-plus-circle"></i> Add New Email Account</h4>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('add_account') }}" method="post">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address:</label>
                            <input type="email" class="form-control" id="email" name="email" required 
                                   placeholder="example@gmail.com">
                            <div class="form-text">Enter Gmail address that will be used for sending emails</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">App Password:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required 
                                       placeholder="xxxx xxxx xxxx xxxx">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password')">
                                    <i class="fas fa-eye" id="password-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <strong>Important:</strong> Use Gmail App Password, not your regular password.
                                <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt"></i> Generate App Password
                                </a>
                            </div>
                        </div>

                        <!-- Default CC/BCC Section -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_cc" class="form-label">Default CC:</label>
                                    <input type="email" class="form-control" id="default_cc" name="default_cc" required
                                           placeholder="cc1@example.com, cc2@example.com" multiple>
                                    <div class="form-text">Comma-separated email addresses for CC (required)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_bcc" class="form-label">Default BCC:</label>
                                    <input type="email" class="form-control" id="default_bcc" name="default_bcc" 
                                           placeholder="bcc1@example.com, bcc2@example.com" multiple>
                                    <div class="form-text">Comma-separated email addresses for BCC (optional)</div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Email Account
                        </button>
                    </form>
                </div>
            </div>

            <!-- Instructions Card -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-info-circle"></i> Setup Instructions</h5>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li><strong>Enable 2-Factor Authentication</strong> on your Gmail account</li>
                        <li><strong>Generate App Password:</strong>
                            <ul>
                                <li>Go to <a href="https://myaccount.google.com/apppasswords" target="_blank">Google App Passwords</a></li>
                                <li>Select "Mail" as the app</li>
                                <li>Copy the 16-character password</li>
                            </ul>
                        </li>
                        <li><strong>Add Account:</strong> Use your Gmail address and the App Password above</li>
                        <li><strong>Default CC/BCC:</strong> Optional default recipients for all emails from this account</li>
                        <li><strong>Daily Limit:</strong> Each account can send up to 15 emails per day</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-users"></i> Email Accounts ({{ account_stats|length }})</h4>
                </div>
                <div class="card-body">
                    {% if account_stats %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Usage Today</th>
                                        <th>Default CC/BCC</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for account in account_stats %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-envelope me-2 {% if account.is_active %}text-success{% else %}text-danger{% endif %}"></i>
                                                <span>{{ account.email }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge {% if account.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                {% if account.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar {% if account.percentage_used < 70 %}bg-success{% elif account.percentage_used < 90 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ account.percentage_used }}%"></div>
                                                </div>
                                                <small>{{ account.sent_today }}/{{ account.limit }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="cc-bcc-display">
                                                {% if account.default_cc %}
                                                    <div class="cc-info">
                                                        <i class="fas fa-copy text-primary" title="CC"></i>
                                                        <span class="small text-truncate" style="max-width: 120px; display: inline-block;" 
                                                              title="{{ account.default_cc }}">{{ account.default_cc }}</span>
                                                    </div>
                                                {% endif %}
                                                {% if account.default_bcc %}
                                                    <div class="bcc-info">
                                                        <i class="fas fa-eye-slash text-secondary" title="BCC"></i>
                                                        <span class="small text-truncate" style="max-width: 120px; display: inline-block;" 
                                                              title="{{ account.default_bcc }}">{{ account.default_bcc }}</span>
                                                    </div>
                                                {% endif %}
                                                {% if not account.default_cc and not account.default_bcc %}
                                                    <small class="text-muted">None set</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        onclick="editAccount({{ account.id }}, '{{ account.email }}', {{ account.is_active|lower }}, '{{ account.default_cc }}', '{{ account.default_bcc }}')"
                                                        data-bs-toggle="modal" data-bs-target="#editModal">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="deleteAccount({{ account.id }}, '{{ account.email }}')"
                                                        data-bs-toggle="modal" data-bs-target="#deleteModal">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Email Accounts</h5>
                            <p class="text-muted">Add your first email account to start sending bulk emails.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div }
    </div>

    <!-- Quick Stats Row -->
    {% if account_stats %}
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ account_stats|length }}</h3>
                    <p class="card-text">Total Accounts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ account_stats|selectattr("is_active")|list|length }}</h3>
                    <p class="card-text">Active Accounts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ account_stats|sum(attribute='sent_today') }}</h3>
                    <p class="card-text">Emails Sent Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ account_stats|selectattr("is_active")|sum(attribute='remaining') }}</h3>
                    <p class="card-text">Remaining Quota</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Email Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email Address:</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">App Password:</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="editPassword" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editPassword')">
                                <i class="fas fa-eye" id="editPassword-icon"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Default CC/BCC Section in Edit Modal -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDefaultCc" class="form-label">Default CC:</label>
                                <input type="email" class="form-control" id="editDefaultCc" name="default_cc" required
                                       placeholder="cc1@example.com, cc2@example.com" multiple>
                                <div class="form-text">Comma-separated email addresses for CC (required)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDefaultBcc" class="form-label">Default BCC:</label>
                                <input type="email" class="form-control" id="editDefaultBcc" name="default_bcc" 
                                       placeholder="bcc1@example.com, bcc2@example.com" multiple>
                                <div class="form-text">Comma-separated email addresses for BCC (optional)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editActive" name="is_active">
                        <label class="form-check-label" for="editActive">
                            Account Active
                        </label>
                    </div>

                    <!-- CC/BCC Preview -->
                    <div class="alert alert-info" id="ccBccPreview" style="display: none;">
                        <h6><i class="fas fa-info-circle"></i> Default Recipients Preview:</h6>
                        <div id="ccPreview"></div>
                        <div id="bccPreview"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Email Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning!</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete the email account:</p>
                <p><strong id="deleteEmailText"></strong></p>
                <p>This will also remove all associated email logs and statistics.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Account</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function editAccount(id, email, isActive, defaultCc, defaultBcc) {
    document.getElementById('editEmail').value = email;
    document.getElementById('editPassword').value = ''; // Don't pre-fill password for security
    document.getElementById('editActive').checked = isActive;
    document.getElementById('editDefaultCc').value = defaultCc || '';
    document.getElementById('editDefaultBcc').value = defaultBcc || '';
    document.getElementById('editForm').action = '/update_account/' + id;
    
    // Update preview
    updateCcBccPreview();
}

function deleteAccount(id, email) {
    document.getElementById('deleteEmailText').textContent = email;
    document.getElementById('deleteForm').action = '/delete_account/' + id;
}

function updateCcBccPreview() {
    const cc = document.getElementById('editDefaultCc').value.trim();
    const bcc = document.getElementById('editDefaultBcc').value.trim();
    const preview = document.getElementById('ccBccPreview');
    const ccPreview = document.getElementById('ccPreview');
    const bccPreview = document.getElementById('bccPreview');
    
    if (cc || bcc) {
        preview.style.display = 'block';
        ccPreview.innerHTML = cc ? `<strong>CC:</strong> ${cc}` : '';
        bccPreview.innerHTML = bcc ? `<strong>BCC:</strong> ${bcc}` : '';
    } else {
        preview.style.display = 'none';
    }
}

// Real-time preview updates
document.addEventListener('DOMContentLoaded', function() {
    const ccField = document.getElementById('editDefaultCc');
    const bccField = document.getElementById('editDefaultBcc');
    
    if (ccField) ccField.addEventListener('input', updateCcBccPreview);
    if (bccField) bccField.addEventListener('input', updateCcBccPreview);
    
    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll('.alert:not(#ccBccPreview)');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(function() {
                alert.remove();
            }, 500);
        }, 5000);
    });
});

// Email validation for CC/BCC fields
function validateEmailList(input) {
    const emails = input.value.split(',').map(email => email.trim()).filter(email => email);
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const invalidEmails = emails.filter(email => !emailRegex.test(email));
    
    if (invalidEmails.length > 0) {
        input.setCustomValidity('Invalid email addresses: ' + invalidEmails.join(', '));
        input.classList.add('is-invalid');
    } else {
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
    }
}

// Add validation to CC/BCC fields
document.addEventListener('DOMContentLoaded', function() {
    const ccFields = document.querySelectorAll('input[name="default_cc"]');
    const bccFields = document.querySelectorAll('input[name="default_bcc"]');
    
    ccFields.forEach(field => {
        field.addEventListener('blur', () => validateEmailList(field));
    });
    
    bccFields.forEach(field => {
        field.addEventListener('blur', () => validateEmailList(field));
    });
});
</script>

<style>
.progress {
    border-radius: 10px;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.btn-group-sm > .btn, .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.modal-content {
    border-radius: 0.5rem;
}

.alert {
    border-radius: 0.5rem;
}

/* CC/BCC Display Styling */
.cc-bcc-display {
    font-size: 0.8rem;
    line-height: 1.2;
}

.cc-info, .bcc-info {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 2px;
}

.cc-info i, .bcc-info i {
    font-size: 0.75rem;
    min-width: 12px;
}

.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Custom styling for better visual hierarchy */
.text-primary { color: #0d6efd !important; }
.text-success { color: #198754 !important; }
.text-info { color: #0dcaf0 !important; }
.text-warning { color: #ffc107 !important; }
.text-danger { color: #dc3545 !important; }

.bg-primary { background-color: #0d6efd !important; }
.bg-success { background-color: #198754 !important; }
.bg-info { background-color: #0dcaf0 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-danger { background-color: #dc3545 !important; }

/* Form validation styling */
.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Responsive table adjustments */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .cc-bcc-display {
        display: none;
    }
}
</style>
{% endblock %}